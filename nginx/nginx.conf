worker_processes 1;

events {
    worker_connections 1024;
}

error_log /dev/stdout debug;

http {
    lua_need_request_body on;
    client_max_body_size 2m;

    resolver 127.0.0.11 ipv6=off;

    upstream ussd_service_alvin {
        server ussd_service_alvin:3000;
    }

    upstream ussd_service_default {
        server ussd_service_default:3000;
    }

    server {
        listen 80;
        server_name _;

        set $backend "ussd_service_default";

        location /ussd {

            access_by_lua_block {
                ngx.log(ngx.INFO, "==== USSD REQUEST START ====")

                ngx.req.read_body()
                local body = ngx.req.get_body_data() or ""
                ngx.log(ngx.INFO, "Raw XML body:\n", body)

                -- Extraction de tous les param√®tres connus
                local function extract(tag)
                    return body:match("<name>"..tag.."</name>%s*<value><string>(.-)</string>") or "NA"
                end

                local session_id = extract("SESSION_ID")
                local sequence   = extract("SEQUENCE")
                local msisdn     = extract("MOBILE_NUMBER")
                local service_key = extract("SERVICE_KEY")
                local request_type = extract("REQUEST_TYPE")
                local ussd_body    = extract("USSD_BODY")
                local end_of_session = extract("END_OF_SESSION")

                ngx.log(ngx.INFO, "Parsed XML parameters:")
                ngx.log(ngx.INFO, "SESSION_ID: ", session_id)
                ngx.log(ngx.INFO, "SEQUENCE: ", sequence)
                ngx.log(ngx.INFO, "MSISDN: ", msisdn)
                ngx.log(ngx.INFO, "SERVICE_KEY: ", service_key)
                ngx.log(ngx.INFO, "REQUEST_TYPE: ", request_type)
                ngx.log(ngx.INFO, "USSD_BODY: ", ussd_body)
                ngx.log(ngx.INFO, "END_OF_SESSION: ", end_of_session)

                -- Routage par MSISDN
                local backend = "ussd_service_default"
                if msisdn ~= "NA" then
                    if string.sub(msisdn,1,7) == "2439709" or string.sub(msisdn,1,7) == "2439802" then
                        backend = "ussd_service_alvin"
                    end
                else
                    ngx.log(ngx.WARN, "MSISDN not found, routing to default")
                end

                ngx.var.backend = backend
                ngx.log(ngx.INFO, "Selected backend: ", backend)
                ngx.log(ngx.INFO, "==== USSD REQUEST END ====")
            }

            # Proxy config
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header Content-Type "text/xml";
            proxy_set_header Connection "";
            proxy_set_body $request_body;  # essentiel pour POST XML

            # Timeouts USSD
            proxy_connect_timeout 5s;
            proxy_send_timeout 5s;
            proxy_read_timeout 5s;

            proxy_pass http://$backend;
        }
    }
}
